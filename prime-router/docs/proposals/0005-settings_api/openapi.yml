openapi: 3.0.2
info:
  title: Prime Data Hub
  description: A router of public health data from multiple senders and receivers
  contact:
    name: USDS at Centers for Disease Control and Prevention
    url: https://open.cdc.gov
    email: usds@cdc.gov
  version: 0.2.0-oas3
paths:

  # The reports end-point handles the
  #
  /reports:
    post:
      summary: Post a report to the data hub
      parameters:
        - in: query
          name: client
          description: The client's name that matches the client name in metadata
          schema:
            type: string
          required: true
          example: simple_report

        - in: query
          name: option
          description: Optional ways to process the request
          required: false
          schema:
            type: string
            enum:
              - ValidatePayload # Validate the payload, but do not process. return 200 on OK or 400 on fail
              - CheckConnections # Health check
              - SkipSend # Validate and route but do not send reports. Data is kept in the hub.
              - SkipInvalidItems # Send valid ones
          example: ValidatePayload

        - in: query
          name: default
          description: Dynamic default values for an element. ':' or %3A is used to seperate element name and value
          required: false
          style: form
          explode: false
          schema:
            type: array
            items:
              type: string
          example: processing_mode_code%3AD

        - in: header
          name: x-functions-key
          description: The Azure function key for the end-point
          schema:
            type: string
          required: true

      requestBody:
        description: The public health information being routed
        required: true
        content:
          text/csv:
            schema:
              type: string
            example:
              header1, header2

              value1, value2

      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'
        '201':
          description: Created. A report was created, but items may have been rejected.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'
        '400':
          description: Invalid request. No report created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Report'
        '500':
          description: Internal Server Error

  # The setting end-point handles the settings for PRIME admins and PHD users
  #
  /settings:
    get:
      description: Get the all the current settings in the system. Must have admin access.
      parameters:
        - in: header
          name: Authorization
          schema:
            type: string
          required: true
      responses:
        '200':
          description: All the current settings for the system
          content:
            application/json:
              schema:
                type: object
                properties:
                  organizations:
                    type: array
                    items:
                      $ref: '#/components/schemas/Organization'
                  senders:
                    type: array
                    items:
                      $ref: '#/components/schemas/Sender'
                  recievers:
                    type: array
                    items:
                      $ref: '#/components/schemas/Receiver'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized

  /settings/organizations:
    get:
      description: The settings for all organizations of the system. Must have admin access.
      parameters:
        - in: header
          name: Authorization
          schema:
            type: string
          required: true
        - in: query
          name: isActive
          description: Fetch organization according to isActive
          schema:
            type: string
          required: false
          example: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Organization'

  /settings/organizations/{organizationName}:
    get:
      description: A single organization settings
      parameters:
        - in: header
          name: Authorization
          schema:
            type: string
          required: true
        - in: path
          required: true
          name: organizationName
          description: The name of the organization
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
    put:
      description: Create or update the direct settings associated with an organization
      parameters:
        - in: header
          name: Authorization
          schema:
            type: string
          required: true
        - in: path
          required: true
          name: organizationName
          description: The name of the organization
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Organization'
      responses:
        '200':
          description: OK, the organization setting was updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '201':
          description: Created, a new organization was added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Organization'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized

  /settings/receivers:
    get:
      description: A list of receivers and their current settings
      parameters:
        - in: header
          name: Authorization
          schema:
            type: string
          required: true
        - in: query
          name: organizationName
          description: Fetch receivers with this organization name
          schema:
            type: string
          required: false
          example: az-phd
        - in: query
          name: isActive
          description: Fetch receivers with isActive set
          schema:
            type: string
          required: false
          example: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Receiver'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized

  /settings/receivers/{receiverName}:
    get:
      description: The settings of a single of receiver
      parameters:
        - in: header
          name: Authorization
          schema:
            type: string
          required: true
        - in: path
          name: receiverName
          description: The name of the receiver
          schema:
            type: string
          required: true
          example: az-phd.elr
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Receiver'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized

    put:
      description: Update a single reciever
      parameters:
        - in: header
          name: Authorization
          schema:
            type: string
          required: true
        - in: path
          name: receiverName
          description: The name of the receiver
          schema:
            type: string
          required: true
          example: az-phd.elr
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Receiver'
      responses:
        '200':
          description: OK, the receiver setting was updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Receiver'
        '201':
          description: Created, the receiver setting was added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Receiver'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized


  /settings/senders:
    get:
      description: A list of senders
      parameters:
        - in: header
          name: Authorization
          schema:
            type: string
          required: true
        - in: query
          name: organizationName
          description: Fetch senders with this organization name
          schema:
            type: string
          required: false
          example: az-phd
        - in: query
          name: isActive
          description: Fetch senders with isActive set
          schema:
            type: string
          required: false
          example: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Receiver'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized

  /settings/senders/{senderName}:
    get:
      description: The settings of a single of sender
      parameters:
        - in: header
          name: Authorization
          schema:
            type: string
          required: true
        - in: path
          name: senderName
          description: The name of a sender to the data hub
          schema:
            type: string
          required: true
          example: simple_report.default
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Sender'
        '400':
          description: Bad Request
        '401':
          description: Unauthorized

    put:
      description: Update a single sender
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Sender'
      responses:
        '200':
          description: OK
        '400':
          description: Bad Request
        '401':
          description: Unauthorized

# Building
components:
  schemas:
    Report:
      type: object
      required: ["id"]
      properties:
        id:
          description: the id for the report assigned by the Hub
          type: string
        reportItemCount:
          description: total number of individual reports sent to the Hub (in a csv, the number of data lines sent)
          type: integer
        destinations:
          description: where the report is being sent to
          type: array
          items:
            type: string
        errorCount:
          description: total errors found during initial validation.  There may be multiple errors per item.
          type: integer
        warningCount:
          description: total warnings found during initial validation.  There may be multiple warnings per item.
          type: integer
        errors:
          description: a list of errors in the report
          type: array
          items:
            $ref: '#/components/schemas/Detail'
        warnings:
          description: a list of warnings in the report
          type: array
          items:
            $ref: '#/components/schemas/Detail'

    Detail:
      type: object
      properties:
        scope:
          type: string
          description: Does the error apply to one item
          enum:
            - Parameter
            - Report
            - Item
        id:
          type: string
          description: Depends on scope, either the item's id (message_id) or the report's id
        detail:
          type: string
          description: The details of the error

    Organization:
      description: An organization connected to data hub
      type: object
      required: ["name", "description"]
      properties:
        name:
          description: the unique id for the organization
          type: string
          example: az-phd
        description:
          description: the displayable description of the organization
          type: string
          example: Arizona PHD
        updated_at:
          description: the time of update
          type: string
          format: date-time
          readOnly: true
        updated_by:
          description: the user_name of who updated the organization
          type: string
          example: jj@phd.gov
          readOnly: true

    Sender:
      description: An sender of reports to the data hub
      type: object
      required:
        - name
        - description
        - topic
        - isActive
        - schema
        - format
      properties:
        name:
          description: Unique name for the senders, includes the orgninzation name
          type: string
          example: simple_report.default
        description:
          description: Display ready description of the sender
          type: string
        topic:
          description: Topic of for this sender
          type: string
          example: covid-19
        organizationName:
          description: Name of the organization that this sender belongs to
          type: string
          example: az-phd
          readOnly: true
        isActive:
          description: is this sender active
          type: boolean
        schema:
          description: the schema name for this sender
          example: az-phd-covid-19
          type: string
        format:
          description: the payload format
          type: string
          enum:
            - CSV
        updated_at:
          description: the time of update
          type: string
          format: date-time
          readOnly: true
        updated_by:
          description: the user_name of who updated the sender
          type: string
          example: jj@phd.gov
          readOnly: true

    Receiver:
      description: A receiver of reports from the data hub
      type: object
      required:
        - name
        - description
        - topic
        - isActive
        - jurisdictionalFilter
        - schema
      properties:
        name:
          description: The unique name for the receiver. Should include the organization name as a prefix.
          type: string
          example: az-phd.elr
        description:
          description: Display ready description of the receiver
          type: string
          example: Arizona PHD ELR feed
        topic:
          description: The topic of for this receiver. Must match the senders.
          type: string
          example: covid-19
        isActive:
          description: Is the receiver active
          type: boolean
          default: true
        organizationName:
          description: The name of the organization that this receiver belongs to
          type: string
          example: az-phd
          readOnly: true
        jurisdictionalFilters:
          description: What items to include in the report.
          type: array
          items:
            description: A single filter
            type: object
            properties:
              state:
                description: The two-letter code for the state
                type: string
                example: AZ
                required: true
              county:
                description: The name of the county (must match FIPS county name)
                type: string
                example: Pima
                required: false
              doesNotMatch:
                description: Ensure that the result does not match
                type: boolean
                default: false
              matchFields:
                description: What fields to match in the filter
                type: string
                enum:
                  - FACILITY_OR_PATIENT
                  - FACILITY_ONLY
        reportConfiguations:
          description: How the report is produced and sent. A report can be sent in multiple ways.
          type: array
          items:
            anyOf:
              - $ref: '#/components/schemas/CustomConfiguration'
              - $ref: '#/components/schemas/HL7StandardConfiguration'
              - $ref: '#/components/schemas/RedoxConfiguration'
              # TODO: add the email configuration
            discriminator:
              propertyName: type
        batching:
          description: When the report is sent
          type: object
          properties:
            frequency:
              description: How often send a report
              type: string
              enum:
                - REAL_TIME
                - HOURLY
                - DAILY
            dailyAt:
              description: The UTC hour to send a daily batch
              type: number
              required: false
        updated_at:
          description: The time of update
          type: string
          format: date-time
          readOnly: true
        updated_by:
          description: The user_name of who updated the receiver
          type: string
          readOnly: true

    HL7StandardConfiguration:
      description: A standard HL7 configuration
      type: object
      properties:
        type:
          description: The discrimenator
          type: string
          required: true
        includeAOE:
          description: Include the AOE
          type: boolean
          required: true
        useBatchHeaders:
          description: Use BHS and FHS header
          type: boolean
          required: true
        useTestProcessingMode:
          description: Set a test process mode flag
          type: boolean
          default: false
          required: false
        receivingApplicationName:
          description: The receiving application name (needed for HL7 formats)
          type: string
          default: null
          required: false
        receivingApplicationOID:
          description: The receiving application OID
          type: string
          default: null
          required: false
        receivingFacilityName:
          description: The receiving facility name
          type: string
          default: null
          required: false
        receivingFacilityOID:
          description: The receiving facility name
          type: string
          default: null
          required: false
        transport:
          oneOf:
            - $ref: '#/components/schemas/SFTPTransport'
            - $ref: '#/components/schemas/DownloadTransport'

    RedoxConfiguration:
      description: A Redox configuration
      type: object
      properties:
        type:
          description: the discrimenator
          type: string
          required: true
        useTestProcessingMode:
          description: Set a test process mode flag
          type: boolean
          default: false
          required: false
        destinationId:
          description: the Redox destination id
          type: string
          example: fcafe93a-9e04-4e3f-9aac-203518f6c4c9
          required: true
        destinationName:
          description: the Redox destination Name
          type: string
          example: CDC Bucks County PDH Destination (p)
          required: true
        sourceId:
          description: The Redox source id
          type: string
          example: a3834c9d-e3ff-4602-b360-dcb0ad08fce5
          required: true
        sourceName:
          description: The Redox source name
          type: string
          example: Prime Data Hub (Prod)
          required: true
        transport:
          description: The redox transport
          oneOf:
            - $ref: '#/components/schemas/RedoxTransport'

    CustomConfiguration:
      description: A custom configuration for a custom schema
      type: object
      properties:
        type:
          description: The discrimenator
          type: string
          required: true
        name:
          description: The name of the custom schema
          type: string
          required: true
        useTestProcessingMode:
          description: Set a test process mode flag
          type: boolean
          default: false
          required: false
        format:
          description: The format of the serializer
          type: string
          enum:
            - CSV
            - HL7
        transport:
          description: The transport to use
          oneOf:
            - $ref: '#/components/schemas/SFTPTransport'
            - $ref: '#/components/schemas/DownloadTransport'

    SFTPTransport:
      description: Describes a single SFTP connection in all of it variations
      type: object
      properties:
        type:
          description: The discriminator
          type: string
          required: true
        host:
          description: Host name and domain
          type: string
          example: sftp.phd.gov
          required: true
        port:
          description: The port to use
          type: number
          example: 22
          required: true
        filePath:
          description: The file path to place the report
          type: string
          example: /in/test
          required: true
  # TODO: Add userName and password when the secrets service is supported

    RedoxTransport:
      description: Describe the Redox transport
      type: object
      properties:
        type:
          description: The discriminator
          type: string
          required: true
        baseUrl:
          description: the base URL to send the Redox message. If missing, production Redox URL is used
          type: string
          default: null
          required: false

    DownloadTransport:
      description: Make the report available for download. A null transport.
      type: object
      properties:
        type:
          description: The discriminator
          type: string
          required: true
